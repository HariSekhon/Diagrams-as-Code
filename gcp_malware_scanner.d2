#!/usr/bin/env d2 --theme 200
#                             gcp_malware_scanner.d2 gcp_malware_scanner.png -h # trick to eat arg
#
#  vim:ts=2:sts=2:sw=2:et:filetype=d2
#
#  Author: Hari Sekhon
#  Date: 2023-06-30 02:59:15 +0100 (Fri, 30 Jun 2023)
#
#  https://github.com/HariSekhon/Diagrams-as-Code
#
#  License: see accompanying Hari Sekhon LICENSE file
#
#  If you're using my code you're welcome to connect with me on LinkedIn and optionally send me feedback to help steer this or other code I publish
#
#  https://www.linkedin.com/in/HariSekhon
#

# ============================================================================ #
#                     G C P   M a l w a r e   S c a n n e r
# ============================================================================ #

direction: right

title: {
  label: GCP Malware Scanner using ClamAV
  near: top-center
  shape: text
  style.font-size: 40
  style.underline: true
}

classes: {
  clamav: {
    label: ClamAV
    # gets 403
    # icon: https://www.clamav.net/assets/clamav-trademark.png
    # surrounded by white
    # icon: https://logowik.com/content/uploads/images/clamav2614.jpg
    icon: https://developer.asustor.com/uploadIcons/0020_999_1622884177_clamav_256.png
    shape: image
  }
  user: {
    label: User
    icon: https://icons.terrastruct.com/essentials%2F365-user.svg
    shape: image
  }
  webapp: {
    label: React
    icon: https://icons.terrastruct.com/dev%2Freact.svg
    # icon: https://diagrams.mingrammer.com/img/resources/programming/framework/react.png
    shape: image
  }
  pod: {
    label: Kubernetes Pod
    icon: https://diagrams.mingrammer.com/img/resources/k8s/compute/pod.png
    shape: image
  }
  gcs: {
    label: GCS bucket
    icon: https://icons.terrastruct.com/gcp%2FProducts%20and%20services%2FStorage%2FCloud%20Storage.svg
    shape: image
  }
  cloudrun: {
    label: Cloud Run
    icon: https://icons.terrastruct.com/gcp%2FProducts%20and%20services%2FCompute%2FCloud%20Run.svg
    shape: image
  }
  gcf: {
    label: Cloud Function
    icon: https://icons.terrastruct.com/gcp%2FProducts%20and%20services%2FCompute%2FCloud%20Functions.svg
    shape: image
  }
  decision: {
    label: Decision
    icon: https://diagrams.mingrammer.com/img/resources/programming/flowchart/decision.png
    shape: image
  }
  animated: {
    style.animated: true
  }
  dash: {
    style.stroke-dash: 5
  }
  invisible: {
    style.opacity: 0
  }
}

user.class: user
clamav.class: clamav

gcp: Google Cloud {
  _.user -> webapp: upload file
  _.clamav -> gke.pod: download updates {class: dash}
  webapp -> unscanned_bucket: save file
  unscanned_bucket -> gcf_scan: trigger
  gcf_scan -> gke.pod: scan file
  gke.pod -> decision: decision
  decision -> clean_bucket: yes
  decision -> quarantined_bucket: no
  clean_bucket -> gcf_clean: trigger
  quarantined_bucket -> gcf_quarantine: trigger
  # gcf_clean -> webapp: notify
  # gcf_quarantine -> webapp: notify

  webapp: {
    label: WebApp
    class: webapp
  }

  unscanned_bucket: {
    label: Unscanned\nBucket
    class: gcs
  }

  clean_bucket: {
    label: Clean\nBucket
    class: gcs
  }

  quarantined_bucket: {
    label: Quarantined\nBucket
    class: gcs
  }

  gcf_scan: {
    class: gcf
    label: Call Malware Scan\nCloud Function
  }

  gcf_clean: {
    class: gcf
    label: Notify WebApp it's Clean\nCloud Function
  }

  gcf_quarantine: {
    class: gcf
    label: Notify WebApp it's Quarantined\nCloud Function
  }

  gke: Google Kubernetes Engine {
    # gke.class: gke
    pod: {
      class: pod
      label: Malware Scanner pod\n(ClamAV)
    }
  }

  decision: {
    label: Decision:\nIs File Clean?
    class: decision
  }
}
